Đây là bản kế hoạch kỹ thuật đã được cập nhật chi tiết dựa trên thông tin bạn cung cấp (File chung `NhatKyXe_Live`, Sheet `Câu trả lời biểu mẫu 1`, Form Public).

Tôi đã điều chỉnh lại các điểm rủi ro và giải pháp để phù hợp với việc dùng chung file Google Sheet này.

---

# KẾ HOẠCH TRIỂN KHAI: ĐĂNG KÝ KHÁCH ONLINE QUA GOOGLE FORM (UPDATED)

## 1. THÔNG TIN HẠ TẦNG & DỮ LIỆU
* **Nguồn dữ liệu:** Google Form (Public - Không cần đăng nhập).
* **Nơi lưu trữ:** File Google Sheet `NhatKyXe_Live`.
    * **Sheet đích:** `Câu trả lời biểu mẫu 1` (Dữ liệu Form đổ về).
    * **Sheet hiện tại:** `Trang tính1` (Đang dùng cho tính năng Nhật ký xe - **Tuyệt đối không chạm vào**).
* **Cấu trúc cột (Sheet Form):**
    * `A`: `timeStamp` (Thời gian gửi)
    * `B`: `userID` (Mã nhân viên - Key quan trọng nhất)
    * `C`: `guestName` (Tên khách)
    * `D`: `CCCD` (Số giấy tờ)
    * `E`: `vendorName` (Tên công ty/NCC)
    * `F`: `plateNo` (Biển số xe)
    * `G`: `jobDetail` (Chi tiết công việc - Lý do)
    * `H`: `SYNC_STATUS` (Trạng thái đồng bộ - Cần Form tự tạo hoặc code tự check cột này).

---

## 2. PHÂN TÍCH RỦI RO & XUNG ĐỘT (DÀNH CHO DEV)

| Điểm Xung Đột | Mức độ | Giải pháp Kỹ thuật (Bắt buộc) |
| :--- | :--- | :--- |
| **1. Public Form Spam** | Cao | Vì Form public, bất kỳ ai có link đều có thể spam. **Giải pháp:** Code phải validate chặt `userID`. Nếu `userID` không tồn tại trong DB -> Đánh dấu `SYNC_STATUS = "ERR: INVALID USER"` và bỏ qua ngay lập tức. Không tạo rác trong DB. |
| **2. Xung đột luồng đọc (I/O)** | Trung bình | File `NhatKyXe_Live` đang được module `Vehicle Log` đọc liên tục. Nếu thêm module mới đọc/ghi cùng lúc có thể gây chậm. **Giải pháp:** Tách biệt rõ ràng function đọc. Module Nhật ký xe chỉ đọc `Trang tính1`. Module Đăng ký chỉ đọc `Câu trả lời biểu mẫu 1`. |
| **3. Quyền hạn (Scope)** | Cao | Code hiện tại (`gsheets_reader.py`) chỉ có quyền `readonly`. Không thể ghi vào cột `SYNC_STATUS`. **Giải pháp:** Phải đổi Scope trong code sang quyền ghi (`spreadsheets`) và đảm bảo Service Account có quyền **Editor** trên file Sheet này. |
| **4. Định dạng dữ liệu** | Thấp | Người dùng nhập tay có thể sai format (có dấu cách, viết hoa/thường). **Giải pháp:** Trim whitespace, uppercase `userID` và `plateNo` trước khi xử lý. |

---

## 3. CHECKLIST GIAO VIỆC (TASK LIST)

### GIAI ĐOẠN 1: CẤU HÌNH (Dành cho Admin/PM)
1.  **Quyền truy cập:** Đảm bảo email của Service Account (trong `credentials.json`) đã được share quyền **Editor** (Chỉnh sửa) trên file `NhatKyXe_Live`. (Quyền Xem là không đủ để cập nhật trạng thái).
2.  **Cột trạng thái:** Đảm bảo trong Sheet `Câu trả lời biểu mẫu 1`, cột **H** là cột dành cho `SYNC_STATUS`. (Nếu Google Form tự thêm cột mới, cần báo Dev điều chỉnh index).

### GIAI ĐOẠN 2: DEV BACKEND (CORE)

#### Task 2.1: Nâng cấp `backend/app/services/gsheets_reader.py`
* **Yêu cầu 1:** Sửa `SCOPES` từ `...spreadsheets.readonly` thành `...spreadsheets` (quyền full).
* **Yêu cầu 2:** Viết hàm `update_cell(spreadsheet_id, range_name, value)`.
    * Dùng để ghi chữ "OK" hoặc "ERROR" vào cột H.
* **Yêu cầu 3:** Viết hàm `read_form_responses(spreadsheet_id)`.
    * Chỉ đọc sheet `Câu trả lời biểu mẫu 1`.
    * Lấy range từ `A2:H` (Bỏ header).

#### Task 2.2: Viết Service Logic (`backend/app/services/form_sync_service.py`)
* **Input:** Dữ liệu thô từ Sheet.
* **Logic xử lý:**
    1.  Lọc các dòng mà cột `SYNC_STATUS` (index 7) là **Rỗng (Empty/None)**.
    2.  Validate `userID` (Cột B):
        * Query DB bảng `User`: `SELECT id FROM users WHERE username = :userID`.
        * *Nếu không thấy:* Ghi log "Invalid User", update Sheet cột H = "ERR: WRONG USER". **Dừng**.
    3.  Validate trùng lặp:
        * Kiểm tra bảng `Guest`: `SELECT id FROM guests WHERE id_card_number = :CCCD AND created_at >= hôm_nay`.
        * *Nếu đã có:* Update Sheet cột H = "DUPLICATED". **Dừng**.
    4.  Tạo Khách (`INSERT`):
        * Map fields:
            * `full_name` = `guestName`
            * `id_card_number` = `CCCD`
            * `license_plate` = `plateNo`
            * `supplier_name` = `vendorName`
            * `reason` = `jobDetail`
            * `registered_by_user_id` = `id` tìm được ở bước 2.
            * `source` = 'google_form' (để dễ thống kê).
            * `status` = 'pending'.
    5.  Thành công: Update Sheet cột H = "OK".

### GIAI ĐOẠN 3: TÍCH HỢP (MAIN APP)

#### Task 3.1: Tạo Job chạy nền (`backend/app/main.py`)
* Thêm job mới vào `scheduler` hiện tại.
* Tên job: `sync_google_form_registrations`.
* Trigger: `IntervalTrigger(seconds=45)` (45 giây/lần).
* **Lưu ý:** Cần `try-except` cẩn thận. Nếu mất mạng hoặc lỗi API Google, job không được làm crash toàn bộ server, chỉ log lỗi và chờ lần chạy sau.

---

## 4. KỊCH BẢN KIỂM THỬ (TESTING)

Sau khi Dev làm xong, bạn cần kiểm tra theo đúng trình tự này để nghiệm thu:

1.  **Test 1: Case Chuẩn**
    * Mở Form (Link public).
    * Nhập `userID` đúng (ví dụ: `NV001`), điền đủ thông tin -> Gửi.
    * Chờ 45s.
    * **Kết quả mong đợi:**
        * Vào Sheet thấy cột H hiện chữ "OK".
        * Vào App An ninh thấy khách mới xuất hiện trong danh sách khách chờ vào.

2.  **Test 2: Case Sai Mã NV (Quan trọng nhất để chống Spam)**
    * Nhập `userID` bậy bạ (ví dụ: `HACKER123`) -> Gửi.
    * Chờ 45s.
    * **Kết quả mong đợi:**
        * Vào Sheet thấy cột H hiện "ERR: WRONG USER" (hoặc mã lỗi tương tự).
        * **Không có** khách nào được tạo trong DB.

3.  **Test 3: Case Thiếu thông tin**
    * Dev cần xử lý trường hợp người dùng nhập thiếu CCCD hoặc Biển số (nếu Form không bắt buộc).
    * Hệ thống nên gán giá trị mặc định (VD: "Không có") thay vì báo lỗi crash server.